<div *ngIf="loading && !load_error" class="loading">
  <div class="loading-spinner"></div>
  <div>Loading recipe...</div>
</div>

<div *ngIf="load_error" class="error">
  <div class="error-icon">!</div>
  <h3>Error Loading Recipe</h3>
  <p>{{error_text}}</p>
  <a [routerLink]="['/recipes']" class="btn btn-primary" style="margin-top: 16px; display: inline-block;">
    Back to recipe list
  </a>
</div>

<div *ngIf="recipe() && !load_error && !loading" class="recipe panel panel-default">
  <div class="panel-heading">
    <div class="recipe-header">
      <h3 class="panel-title">{{ recipe()?.title }}</h3>
      <div class="recipe-badges">
        <span class="badge badge-category" *ngIf="recipe()?.category">
          {{ recipe()?.category }}
        </span>
        <span class="badge badge-difficulty" [class.easy]="recipe()?.difficulty === 'Easy'"
          [class.medium]="recipe()?.difficulty === 'Medium'"
          [class.hard]="recipe()?.difficulty === 'Hard'">
          {{ recipe()?.difficulty || 'Medium' }}
        </span>
      </div>

      <button
        type="button"
        class="btn btn-secondary save-detail-button"
        (click)="recipe()?.id && favorites.toggle(recipe()!.id)"
        *ngIf="auth.isLoggedIn()"
      >
        {{ favorites.isSaved(recipe()?.id) ? 'Saved' : 'Save' }}
      </button>
    </div>
  </div>
  
  <div class="panel-body">
    <div class="recipe-hero">
      <div class="hero-media">
        <img
          class="hero-image"
          [src]="recipe()?.cover_photo || '/assets/empty-bowl.png'"
          [alt]="recipe()?.title + ' cover photo'"
        />
      </div>

      <div class="hero-meta">
        <div class="meta-chip rating-chip">
          <div class="meta-label">Rating</div>
          <div class="meta-value">
            <span *ngIf="!ratingsConfigured">Ratings not enabled</span>
            <span *ngIf="ratingsConfigured && ratingSummary.count > 0">{{ ratingSummary.avg | number:'1.1-1' }} / 5</span>
            <span *ngIf="ratingsConfigured && ratingSummary.count === 0">No ratings yet</span>
          </div>
          <div class="meta-sub" *ngIf="ratingsConfigured && ratingSummary.count > 0">
            {{ ratingSummary.count }} {{ ratingSummary.count === 1 ? 'rating' : 'ratings' }}
          </div>
          <div class="meta-sub" *ngIf="!ratingsConfigured">
            Configure `appwriteRatingsCollectionId` to enable community ratings.
          </div>
        </div>

        <div class="meta-chip">
          <div class="meta-label">Prep time</div>
          <div class="meta-value">{{ recipe()?.preparation_time }} min</div>
        </div>
        <div class="meta-chip">
          <div class="meta-label">Servings</div>
          <div class="meta-value">
            {{recipe()?.feeds_this_many}} {{recipe()?.feeds_this_many === 1 ? 'person' : 'people'}}
          </div>
        </div>
        <div class="meta-chip" *ngIf="recipe()?.category">
          <div class="meta-label">Category</div>
          <div class="meta-value">{{ recipe()?.category }}</div>
        </div>
        <div class="meta-chip" *ngIf="recipe()?.difficulty">
          <div class="meta-label">Difficulty</div>
          <div class="meta-value">{{ recipe()?.difficulty }}</div>
        </div>

        <div class="meta-chip rate-chip" *ngIf="ratingsConfigured && auth.isLoggedIn()">
          <div class="meta-label">Your rating</div>
          <div class="stars" role="radiogroup" aria-label="Rate this recipe">
            <button
              class="star"
              type="button"
              *ngFor="let v of [1,2,3,4,5]"
              [class.active]="(myRating || 0) >= v"
              (click)="setRating(v)"
              [attr.aria-checked]="(myRating || 0) === v"
              role="radio"
            >
              ★
            </button>
          </div>
          <div class="meta-sub" *ngIf="ratingError">{{ ratingError }}</div>
          <div class="meta-sub" *ngIf="!ratingError && myRating">You rated this {{ myRating }}/5</div>
          <div class="meta-sub" *ngIf="!ratingError && !myRating">Tap a star to rate</div>
        </div>
      </div>
    </div>

    <p class="recipe-description">{{ recipe()?.description }}</p>

    <div class="ingredients">
      <div class="data_title">Ingredients</div>
      <ol>
        <li *ngFor="let ingredient of recipe()?.ingredients">
          <strong>{{ ingredient.name }}</strong>
          <span *ngIf="ingredient.quantity"> - {{ ingredient.quantity }} {{ ingredient.unit }}</span>
        </li>
      </ol>
    </div>

    <div class="instructions">
      <div class="data_title">Instructions</div>
      <ol>
        <li *ngFor="let instruction of recipe()?.instructions; let i = index">
          <div class="instruction-step">
            <div class="step-number">{{ i + 1 }}</div>
            <div class="step-content">
              <div class="step-text">{{ instruction.action }}</div>
              <img 
                *ngIf="instruction.photo" 
                [src]="instruction.photo.startsWith('http') ? instruction.photo : '/assets/images/' + instruction.photo"
                [alt]="'Step ' + (i + 1) + ' instruction photo'"
              />
            </div>
          </div>
        </li>
      </ol>
    </div>

    <div class="recipe-actions" *ngIf="recipe()?.id">
      <button class="btn btn-primary" (click)="goBack()">← Back</button>
      <button class="btn btn-danger" (click)="deleteRecipe()">Delete Recipe</button>
    </div>
  </div>
</div>
  